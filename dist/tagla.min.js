(function(){var t;t=function(){function t(t){var e,a;null==t&&(t={}),a=this.getParams("debug"),e=e||{},this.debug=a?"true"===a||"1"===a:e.debug?e.debug===!0:!1,this._listeners=[]}return t.prototype.toString=function(){return"Base"},t.prototype.log=function(t,e){this.debug&&(e=e||"info",window.console&&window.console[e]&&window.console[e]("["+this.toString()+"] "+t))},t.prototype.on=function(t,e){if(!t||!e)throw new Error("Both event type and callback are required parameters");return this.log("on() - event '"+t+"' is subscribed"),this._listeners[t]||(this._listeners[t]=[]),e.instance=this,this._listeners[t].push(e),e},t.prototype.emit=function(t,e){var a;if(null==e&&(e=[]),this.log("emit() - event '"+t+"' is triggered"),e.unshift({type:t,target:this}),!t)throw new Error("Lacks of type parameter");if(this._listeners[t]&&this._listeners[t].length)for(a in this._listeners[t])this._listeners[t][a].apply(this,e);return this},t.prototype.getParams=function(t){var e,a,i,n,r,s;i=this.getUrl(),r={},s=i.indexOf("?"),this.log("getParams() is executed"),a=-1!==i.indexOf("#")?i.slice(s+1,i.indexOf("#")).split("&"):i.slice(s+1).split("&");for(n in a)e=a[n].split("="),r[e[0]]=e[1];return t?r[t]:r},t.prototype.getUrl=function(){return window.location.href},t}(),window.Stackla||(window.Stackla={}),window.Stackla.Base=t}).call(this),function(){var t,e=function(t,e){function i(){this.constructor=t}for(var n in e)a.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},a={}.hasOwnProperty;t=function(t){function a(t,e){return a.__super__.constructor.call(this),this.init(t),this.bind(),this.render(e),this}return e(a,t),a.prototype.toString=function(){return"ImageSize"},a.prototype.init=function(t){return this.el=$(t)[0],this.complete=this.el.complete,this.data={},this._timer=null,this.data.width=this.el.width,this.data.height=this.el.height},a.prototype.bind=function(){return this.log("bind() is executed"),$(window).resize(function(t){return function(){var e;return(e=t.el.width===t.data.width&&t.el.height===t.data.height)?void 0:($.extend(t.data,{width:t.el.width,height:t.el.height,widthRatio:t.el.width/t.data.naturalWidth,heightRatio:t.el.height/t.data.naturalHeight}),t.log("handleResize() is executed"),t.emit("change",[t.data]))}}(this))},a.prototype.render=function(t){var e;return this.log("render() is executed"),this.complete?(e=new Image,e.src=this.el.src,this.log("Image '"+this.el.src+"' is loaded"),this.data.naturalWidth=e.width,this.data.naturalHeight=e.height,t(!0,this.data)):(this.log("Image '"+this.el.src+"' is NOT ready"),e=new Image,e.src=this.el.src,e.onload=function(a){return function(){return a.log("Image '"+e.src+"' is loaded"),a.data.naturalWidth=e.width,a.data.naturalHeight=e.height,t(!0,a.data)}}(this),e.onerror=function(a){return function(){return a.log("Image '"+e.src+"' is failed to load"),t(!1,a.data)}}(this))},a}(Stackla.Base),window.Stackla||(window.Stackla={}),Stackla.getImageSize=function(e,a){return new t(e,a)}}.call(this),function(){var t,e,a,i=function(t,e){function a(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return a.prototype=e.prototype,t.prototype=new a,t.__super__=e.prototype,t},n={}.hasOwnProperty;t={NAME:"Tagla",PREFIX:"tagla-",DRAG_ATTR:{containment:".tagla",handle:".tagla-icon"},SELECT_ATTR:{allow_single_deselect:!0,placeholder_text_single:"Select an option",width:"310px"},FORM_TEMPLATE:['<div class="tagla-form-wrapper">','    <form class="tagla-form">','        <div class="tagla-form-title">',"            Select Your Product",'            <a href="javascript:void(0);" class="tagla-form-close">Ã—</a>',"        </div>",'        <input type="hidden" name="x">','        <input type="hidden" name="y">','        <select data-placeholder="Search" type="text" name="tag" class="tagla-select chosen-select" placeholder="Search">',"            <option></option>",'            <option value="1">Cockie</option>','            <option value="2">Kiwi</option>','            <option value="3">Buddy</option>',"        </select>","    </form>","</div>"].join("\n"),TAG_TEMPLATE:['<div class="tagla-tag">','    <i class="tagla-icon fs fs-tag2"></i>','    <div class="tagla-dialog">',"    {{#product}}","        {{#image_small_url}}",'        <div class="tagla-dialog-image">','          <img src="{{image_small_url}}">',"        </div>","        {{/image_small_url}}",'        <div class="tagla-dialog-text">','          <div class="tagla-dialog-edit">','            <a href="javascript:void(0)" class="tagla-tag-link tagla-tag-edit-link">','              <i class="fs fs-pencil"></i> Edit',"            </a>",'            <a href="javascript:void(0)" class="tagla-tag-link tagla-tag-delete-link">','              <i class="fs fs-cross3"></i> Delete',"            </a>","          </div>",'          <h2 class="tagla-dialog-title">{{tag}}</h2>',"          {{#price}}",'          <div class="tagla-dialog-price">{{price}}</div>',"          {{/price}}","          {{#description}}",'          <p class="tagla-dialog-description">{{description}}</p>',"          {{/description}}","          {{#custom_url}}",'          <a href="{{custom_url}}" class="tagla-dialog-button st-btn st-btn-success st-btn-solid" target=""{{target}}">','            <i class="fs fs-cart"></i>',"            Buy Now","          </a>","          {{/custom_url}}","        </div>","    {{/product}}","    </div>","    {{{form_html}}}","</div>"].join("\n"),NEW_TAG_TEMPLATE:['<div class="tagla-tag">','    <i class="tagla-icon fs fs-tag2"></i>',"</div>"].join("\n")},e=function(t){function e(t,a){null==a&&(a={}),e.__super__.constructor.call(this),this.wrapper=$(t),this.init(a),this.bind()}return i(e,t),e}(Stackla.Base),$.extend(e,t),a={toString:function(){return"Tagla"},_applyTools:function(t){var a,i,n,r;return n=new Draggabilly(t[0],e.DRAG_ATTR),n.on("dragEnd",$.proxy(this.handleTagMove,this)),t.data("draggabilly",n),r=t.data("tag-data"),a=t.find(".tagla-form"),a.find("[name=x]").val(r.x),a.find("[name=y]").val(r.y),a.find("[name=tag] option[value="+r.value+"]").attr("selected","selected"),i=t.find(".tagla-select"),i.chosen2(e.SELECT_ATTR),i.on("change",$.proxy(this.handleTagChange,this)),i.on("chosen:hiding_dropdown",function(){return i.trigger("chosen:open")})},_disableDrag:function(t){return this.editor!==!1?(this.log("_disableDrag() is executed"),t=$(t),$(".tagla-tag").each(function(){return t[0]!==this?$(this).data("draggabilly").disable():void 0})):void 0},_enableDrag:function(t){return this.editor!==!1?(this.log("_enableDrag() is executed"),t=$(t),$(".tagla-tag").each(function(){return t[0]!==this?$(this).data("draggabilly").enable():void 0})):void 0},_removeTools:function(t){var e;return t.data("draggabilly").destroy(),e=t.find(".tagla-select"),e.show().removeClass("chzn-done"),e.next().remove()},_getPosition:function(t){var e,a,i;return this.log("_getPosition() is executed"),e=t.position(),a=(e.left+t.width()/2)/this.currentWidth*this.naturalWidth,i=(e.top+t.height()/2)/this.currentHeight*this.naturalHeight,"percent"===this.unit&&(a=a/this.naturalWidth*100,i=i/this.naturalHeight*100),[a,i]},_updateImageSize:function(t){return this.log("_updateImageSize() is executed"),this.naturalWidth=t.naturalWidth,this.naturalHeight=t.naturalHeight,this.currentWidth=t.width,this.currentHeight=t.height,this.widthRatio=t.widthRatio,this.heightRatio=t.heightRatio},handleTagClick:function(t){var e;return t.preventDefault(),t.stopPropagation(),$(t.target).hasClass("tagla-icon")?(this.log("handleTagClick() is executed"),e=$(t.currentTarget),this.shrink(e),e.addClass("tagla-tag-active"),e.data("draggabilly").enable()):void 0},handleTagChange:function(t){var e,a,i,n,r;return this.log("handleTagChange() is executed"),e=$(t.target),a=e.parents(".tagla-tag"),n=a.hasClass("tagla-tag-new"),a.removeClass("tagla-tag-choose tagla-tag-active tagla-tag-new"),i=$.extend({},a.data("tag-data")),i.label=e.find("option:selected").text(),i.value=e.val()||i.label,r=a.find(".tagla-form").serialize(),n?this.emit("add",[i,r,a]):this.emit("change",[i,r,a])},handleTagDelete:function(t){var e,a;return this.log("handleTagDelete() is executed"),t.preventDefault(),e=$(t.currentTarget).parents(".tagla-tag"),a=$.extend({},e.data("tag-data")),e.fadeOut(function(t){return function(){return t._removeTools(e),e.remove(),t.emit("delete",[a])}}(this))},handleTagEdit:function(t){var e,a;return this.log("handleTagEdit() is executed"),t.preventDefault(),t.stopPropagation(),e=$(t.currentTarget).parents(".tagla-tag"),e.addClass("tagla-tag-choose"),this.wrapper.addClass("tagla-editing-selecting"),this._disableDrag(e),e.find(".tagla-select").trigger("chosen:open"),a=$.extend({},e.data("tag-data")),this.emit("edit",[a])},handleTagMove:function(t){var e,a,i,n,r;return this.log("handleTagMove() is executed"),a=$(t.element),i=a.data("tag-data"),n=this._getPosition(a),i.x=n[0],i.y=n[1],e=a.find(".tagla-form"),e.find("[name=x]").val(i.x),e.find("[name=y]").val(i.y),r=a.find(".tagla-form").serialize(),this.lastDragTime=new Date,i=$.extend({},i),i.id?this.emit("move",[i,r,a]):void 0},handleTagMouseEnter:function(t){var e,a;return this.log("handleTagMouseEnter"),e=$(t.currentTarget),a=e.data("timer"),a&&clearTimeout(a),e.removeData("timer"),e.addClass("tagla-tag-hover")},handleTagMouseLeave:function(t){var e,a;return this.log("handleTagMouseLeave"),e=$(t.currentTarget),a=e.data("timer"),a&&clearTimeout(a),e.removeData("timer"),a=setTimeout(function(){return e.removeClass("tagla-tag-hover")},300),e.data("timer",a)},handleWrapperClick:function(){return this.log("handleWrapperClick() is executed"),new Date-this.lastDragTime>10?this.shrink():void 0},handleImageResize:function(t,e){var a,i;return this.log("handleImageResize() is executed"),i=this.currentWidth,a=this.currentHeight,$(".tagla-tag").each(function(){var t,n,r,s;return t=$(this),n=t.position(),r=n.left/i*e.width,s=n.top/a*e.height,t.css({left:r+"px",top:s+"px"})}),this._updateImageSize(e)},addTag:function(t){var e,a,i,n,r,s;return null==t&&(t={}),this.log("addTag() is executed"),t=$.extend({},t),t.form_html=this.formHtml,e=$(Mustache.render(this.tagTemplate,t)),a=!t.x&&!t.y,a&&$(".tagla-tag").each(function(){return $(this).hasClass("tagla-tag-new")&&!$(this).find("[name=tag]").val()?$(this).fadeOut(function(t){return function(){return t._removeTools(e)}}(this)):void 0}),this.wrapper.append(e),a&&(t.x=50,t.y=50,e.addClass("tagla-tag-new tagla-tag-active tagla-tag-choose")),"percent"===this.unit?(r=this.currentWidth*(t.x/100),s=this.currentHeight*(t.y/100)):(r=t.x*this.widthRatio,s=t.y*this.heightRatio),i=e.outerWidth()/2,n=e.outerHeight()/2,e.css({left:r-i+"px",top:s-n+"px"}),e.data("tag-data",t),this.editor&&(this._applyTools(e),a)?(e.data("draggabilly").enable(),e.addClass("tagla-tag-choose"),setTimeout(function(t){return function(){return t.wrapper.addClass("tagla-editing-selecting"),e.find(".tagla-select").trigger("chosen:open"),t._disableDrag(e)}}(this),100)):void 0},deleteTag:function(){return this.log("deleteTag() is executed")},edit:function(){return this.editor!==!0?(this.log("edit() is executed"),this.wrapper.addClass("tagla-editing"),$(".tagla-tag").each(function(){return this._applyTools($(this))}),this.editor=!0):void 0},getTags:function(){var t;return this.log("getTags() is executed"),t=[],$(".tagla-tag").each(function(){var e;return e=$.extend({},$(this).data("tag-data")),t.push($(this).data("tag-data"))}),t},shrink:function(t){return null==t&&(t=null),this.editor!==!1?(this.log("shrink() is executed"),t=$(t),$(".tagla-tag").each(function(e){return function(a,i){var n;if(t[0]!==i)return n=$(i),n.hasClass("tagla-tag-new")&&!n.find("[name=tag]").val()&&n.fadeOut(function(){return n.remove(),e._removeTools(n)}),n.removeClass("tagla-tag-active tagla-tag-choose")}}(this)),this.wrapper.removeClass("tagla-editing-selecting"),this._enableDrag()):void 0},updateDialog:function(t,e){var a;return e=$.extend({},t.data("tag-data"),e),e.form_html=this.formHtml,a=$(Mustache.render(this.tagTemplate,e)).find(".tagla-dialog").html(),t.find(".tagla-dialog").html(a),t.data("tag-data",e)},unedit:function(){return this.edit!==!1?(this.log("unedit() is executed"),$(".tagla-tag").each(function(t){return function(e,a){return t._removeTools($(a))}}(this)),this.wrapper.removeClass("tagla-editing"),this.editor=!1):void 0},init:function(t){var a;return this.data=t.data||[],this.editor=null!=(a=t.editor===!0)?a:{on:!1},this.formHtml=$(t.form?t.form:e.FORM_TEMPLATE),this.formHtml=this.formHtml.html(),this.tagTemplate=t.tagTemplate?$(t.tagTemplate).html():e.TAG_TEMPLATE,this.unit="percent"===t.unit?"percent":"pixel",this.imageSize=null,this.image=this.wrapper.find("img"),this.lastDragTime=new Date},bind:function(){return this.log("bind() is executed"),this.wrapper.on("mouseenter",$.proxy(this.handleMouseEnter,this)).on("click",$.proxy(this.handleWrapperClick,this)).on("click",".tagla-tag-edit-link",$.proxy(this.handleTagEdit,this)).on("click",".tagla-tag-delete-link",$.proxy(this.handleTagDelete,this)).on("mouseenter",".tagla-tag",$.proxy(this.handleTagMouseEnter,this)).on("mouseleave",".tagla-tag",$.proxy(this.handleTagMouseLeave,this))},render:function(){return this.log("render() is executed"),this.image.attr("draggable",!1),this.imageSize=Stackla.getImageSize(this.image,$.proxy(this.renderFn,this)),this.imageSize.on("change",$.proxy(this.handleImageResize,this))},renderFn:function(t,e){var a,i,n,r,s;if(this.log("renderFn() is executed"),a=/Safari/.test(navigator.userAgent)&&/Apple Computer/.test(navigator.vendor),!t)return this.log("Failed to load image: "+this.image.attr("src"),"error"),void this.destroy();for(this._updateImageSize(e),this.wrapper.addClass("tagla"),a&&this.wrapper.addClass("tagla-safari"),r=this.data,i=0,n=r.length;n>i;i++)s=r[i],this.addTag(s);return setTimeout(function(t){return function(){return t.editor&&t.wrapper.addClass("tagla-editing"),t.emit("ready",[t])}}(this),500)},destroy:function(){return this.log("destroy() is executed"),this.wrapper.removeClass("tagla tagla-editing"),this.wrapper.find(".tagla-tag").each(function(){var t;return t=$(this),t.find(".tagla-select").chosen2("destroy"),t.data("draggabilly").destroy(),t.remove()})}},$.extend(e.prototype,a),window.Stackla||(window.Stackla={}),window.Stackla.Tagla=e}.call(this);